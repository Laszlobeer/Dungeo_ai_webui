<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Adventure</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="theme-{{ theme or 'light' }}">  <!-- Added default theme -->
    {% include 'model_bar.html' %}
    
    <div class="container">
        <div class="game-container">
            <div class="world-state">
                <h2><i class="fas fa-globe"></i> World State</h2>
                <div id="world-state-content">
                    <!-- World state will be populated dynamically -->
                </div>
            </div>
            
            <div class="adventure-log">
                <div id="conversation">
                    <!-- Conversation will be populated dynamically -->
                </div>
                
                <div class="input-area">
                    <input type="text" id="command-input" placeholder="Enter your action...">
                    <button id="submit-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
                
                <div id="consequence-display">
                    <h3><i class="fas fa-exclamation-triangle"></i> Consequence:</h3>
                    <p id="consequence-text"></p>
                </div>
            </div>
        </div>
        
        <div class="system-prompt">
            <h3><i class="fas fa-robot"></i> AI System Prompt</h3>
            <div class="system-prompt-content">
                {{ system_prompt }}
            </div>
        </div>
        
        <audio id="tts-player" controls class="hidden"></audio>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const commandInput = document.getElementById('command-input');
            const submitBtn = document.getElementById('submit-btn');
            const conversationDiv = document.getElementById('conversation');
            const consequenceText = document.getElementById('consequence-text');
            const worldStateContent = document.getElementById('world-state-content');
            const ttsPlayer = document.getElementById('tts-player');
            const censoredBtn = document.getElementById('censored-btn');
            const redoBtn = document.getElementById('redo-btn');
            const saveBtn = document.getElementById('save-btn');
            const consequencesBtn = document.getElementById('consequences-btn');
            const helpBtn = document.getElementById('help-btn');
            
            // Add initial DM message (using tojson for proper escaping)
            const initialMessage = {{ session.last_ai_reply | tojson }} || 'Welcome to your adventure!';
            if (initialMessage) {
                addMessage('dm', initialMessage);
            }
            
            // NSFW State Management
            let nsfwOn = {{ nsfw_on | default(false) | tojson }};  // Get initial state from backend
            
            // Function to update eye icon based on NSFW state
            function updateCensoredIcon() {
                const icon = censoredBtn.querySelector('i');
                if (nsfwOn) {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                } else {
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                }
            }
            
            // Initialize eye icon
            updateCensoredIcon();
            
            // Submit command
            function submitCommand() {
                const command = commandInput.value.trim();
                if (!command) return;
                
                commandInput.value = '';
                
                // Add player message to conversation
                addMessage('player', command);
                
                // Show loading indicator
                submitBtn.disabled = true;
                submitBtn.innerHTML = "<i class='fas fa-spinner fa-spin'></i>";
                
                // Send command to server
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `command=${encodeURIComponent(command)}`
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { 
                            throw new Error(text || 'Server error');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Add DM response
                        addMessage('dm', data.message);
                        
                        // Update consequence display
                        consequenceText.textContent = data.consequence;
                        
                        // Update world state
                        if (data.world_state) {
                            worldStateContent.innerHTML = data.world_state.replace(/\n/g, '<br>');
                        }
                        
                        // Play TTS if available
                        if (data.audio_url) {
                            ttsPlayer.src = data.audio_url;
                            ttsPlayer.classList.remove('hidden');
                            ttsPlayer.play().catch(e => {
                                console.error('Failed to play audio:', e);
                                addMessage('system', 'Audio playback failed');
                            });
                        }
                    } else {
                        addMessage('system', data.message || 'Error processing command');
                    }
                })
                .catch(error => {
                    try {
                        const errorData = JSON.parse(error.message);
                        addMessage('system', errorData.message || 'Error processing command');
                    } catch (e) {
                        addMessage('system', 'Reality glitches... try again');
                    }
                    console.error('Error:', error);
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = "<i class='fas fa-paper-plane'></i>";
                });
            }
            
            submitBtn.addEventListener('click', submitCommand);
            commandInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitCommand();
                }
            });
            
            // Add message to conversation
            function addMessage(speaker, text) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', speaker);
                
                const speakerSpan = document.createElement('div');
                speakerSpan.classList.add('speaker');
                if (speaker === 'dm') {
                    speakerSpan.innerHTML = '<i class="fas fa-dragon"></i> Dungeon Master';
                } else if (speaker === 'player') {
                    speakerSpan.innerHTML = '<i class="fas fa-user"></i> You';
                } else {
                    speakerSpan.innerHTML = '<i class="fas fa-info-circle"></i> System';
                }
                
                const textDiv = document.createElement('div');
                textDiv.classList.add('text');
                textDiv.textContent = text;
                
                messageDiv.appendChild(speakerSpan);
                messageDiv.appendChild(textDiv);
                conversationDiv.appendChild(messageDiv);
                
                // Scroll to bottom
                conversationDiv.scrollTop = conversationDiv.scrollHeight;
            }
            
            // Button handlers
            censoredBtn.addEventListener('click', function() {
                // Optimistically update UI
                nsfwOn = !nsfwOn;
                updateCensoredIcon();
                
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'command=/censored'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        addMessage('system', data.message);
                    } else {
                        // Revert on error
                        nsfwOn = !nsfwOn;
                        updateCensoredIcon();
                        addMessage('system', data.message || 'Error toggling NSFW mode');
                    }
                })
                .catch(error => {
                    // Revert on network error
                    nsfwOn = !nsfwOn;
                    updateCensoredIcon();
                    addMessage('system', 'Network error. NSFW mode not toggled.');
                });
            });
            
            redoBtn.addEventListener('click', function() {
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'command=/redo'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Remove last DM message and add new one
                        const dmMessages = document.querySelectorAll('.message.dm');
                        if (dmMessages.length > 0) {
                            dmMessages[dmMessages.length - 1].remove();
                        }
                        addMessage('dm', data.message);
                        
                        // Play TTS if available
                        if (data.audio_url) {
                            ttsPlayer.src = data.audio_url;
                            ttsPlayer.classList.remove('hidden');
                            ttsPlayer.play().catch(e => {
                                console.error('Failed to play audio:', e);
                                addMessage('system', 'Audio playback failed');
                            });
                        }
                    } else {
                        addMessage('system', data.message);
                    }
                });
            });
            
            saveBtn.addEventListener('click', function() {
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'command=/save'
                })
                .then(response => response.json())
                .then(data => {
                    addMessage('system', data.message);
                });
            });
            
            consequencesBtn.addEventListener('click', function() {
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'command=/consequences'
                })
                .then(response => response.json())
                .then(data => {
                    addMessage('system', data.message);
                });
            });
        });
    </script>
</body>
</html>