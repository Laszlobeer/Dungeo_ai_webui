<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Adventure</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="theme-{{ theme or 'fantasy' }}">
    {% include 'model_bar.html' %}
    
    <div class="container">
        <div class="game-container">
            <div class="world-state">
                <h2><i class="fas fa-globe"></i> World State</h2>
                <div id="world-state-content">
                    <!-- World state will be populated dynamically -->
                </div>
            </div>
            
            <div class="adventure-log">
                <div id="conversation">
                    <!-- Conversation will be populated dynamically -->
                </div>
                
                <div class="input-area">
                    <input type="text" id="command-input" placeholder="Enter your action...">
                    <button id="submit-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
                
                <div id="consequence-display">
                    <h3><i class="fas fa-exclamation-triangle"></i> Consequence:</h3>
                    <p id="consequence-text"></p>
                </div>
            </div>
        </div>
        
        <div class="freedom-tips">
            <h3><i class="fas fa-lightbulb"></i> Freedom Tips</h3>
            <ul>
                <li>Try ANY action - the world will adapt to your choices</li>
                <li>Use "create [type] [name]" to add new elements to the world</li>
                <li>Start commands with "I bend the story to..." for narrative control</li>
                <li>Your actions have permanent consequences that shape the world</li>
            </ul>
        </div>
        
        <div class="system-prompt">
            <h3><i class="fas fa-robot"></i> AI System Prompt</h3>
            <div class="system-prompt-content">
                {{ system_prompt }}
            </div>
        </div>
        
        <audio id="tts-player" controls class="hidden"></audio>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const commandInput = document.getElementById('command-input');
            const submitBtn = document.getElementById('submit-btn');
            const conversationDiv = document.getElementById('conversation');
            const consequenceText = document.getElementById('consequence-text');
            const worldStateContent = document.getElementById('world-state-content');
            const ttsPlayer = document.getElementById('tts-player');
            const censoredBtn = document.getElementById('censored-btn');
            const redoBtn = document.getElementById('redo-btn');
            const saveBtn = document.getElementById('save-btn');
            const consequencesBtn = document.getElementById('consequences-btn');
            const helpBtn = document.getElementById('help-btn');
            
            // Add initial DM message
            const initialMessage = {{ session.last_ai_reply | tojson }} || 'Welcome to your adventure!';
            if (initialMessage) {
                addMessage('dm', initialMessage);
            }
            
            // Submit command
            function submitCommand() {
                const command = commandInput.value.trim();
                if (!command) return;
                
                commandInput.value = '';
                
                // Add player message to conversation
                addMessage('player', command);
                
                // Send command to server
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `command=${encodeURIComponent(command)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Add DM response
                        addMessage('dm', data.message);
                        
                        // Update consequence display
                        consequenceText.textContent = data.consequence;
                        
                        // Update world state
                        if (data.world_state) {
                            worldStateContent.innerHTML = data.world_state.replace(/\n/g, '<br>');
                        }
                        
                        // Play TTS if available
                        if (data.audio_url) {
                            ttsPlayer.src = data.audio_url;
                            ttsPlayer.classList.remove('hidden');
                            ttsPlayer.play();
                        }
                    } else {
                        addMessage('system', data.message || 'Error processing command');
                    }
                })
                .catch(error => {
                    addMessage('system', 'Error processing command');
                    console.error('Error:', error);
                });
            }
            
            submitBtn.addEventListener('click', submitCommand);
            commandInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitCommand();
                }
            });
            
            // Add message to conversation with freedom formatting
            function addMessage(speaker, text) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', speaker);
                
                const speakerSpan = document.createElement('div');
                speakerSpan.classList.add('speaker');
                if (speaker === 'dm') {
                    speakerSpan.textContent = 'Dungeon Master';
                } else if (speaker === 'player') {
                    speakerSpan.textContent = 'You';
                } else {
                    speakerSpan.textContent = 'System';
                }
                
                const textDiv = document.createElement('div');
                textDiv.classList.add('text');
                
                // Format narrative commands differently
                const lowerText = text.toLowerCase();
                if (lowerText.includes("bend the story") || 
                    lowerText.includes("reshape reality") ||
                    lowerText.includes("i wish that") ||
                    lowerText.includes("let there be") ||
                    lowerText.includes("reality shifts") ||
                    lowerText.includes("i create") ||
                    lowerText.includes("i manifest")) {
                    textDiv.innerHTML = `<span class="reality-shift">${text}</span>`;
                } else {
                    textDiv.textContent = text;
                }
                
                messageDiv.appendChild(speakerSpan);
                messageDiv.appendChild(textDiv);
                conversationDiv.appendChild(messageDiv);
                
                // Scroll to bottom
                conversationDiv.scrollTop = conversationDiv.scrollHeight;
            }
            
            // Button handlers
            censoredBtn.addEventListener('click', function() {
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'command=/censored'
                })
                .then(response => response.json())
                .then(data => {
                    addMessage('system', data.message);
                });
            });
            
            redoBtn.addEventListener('click', function() {
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'command=/redo'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Remove last DM message and add new one
                        const dmMessages = document.querySelectorAll('.message.dm');
                        if (dmMessages.length > 0) {
                            dmMessages[dmMessages.length - 1].remove();
                        }
                        addMessage('dm', data.message);
                        
                        // Play TTS if available
                        if (data.audio_url) {
                            ttsPlayer.src = data.audio_url;
                            ttsPlayer.classList.remove('hidden');
                            ttsPlayer.play();
                        }
                    } else {
                        addMessage('system', data.message);
                    }
                });
            });
            
            saveBtn.addEventListener('click', function() {
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'command=/save'
                })
                .then(response => response.json())
                .then(data => {
                    addMessage('system', data.message);
                });
            });
            
            consequencesBtn.addEventListener('click', function() {
                fetch('/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'command=/consequences'
                })
                .then(response => response.json())
                .then(data => {
                    addMessage('system', data.message);
                });
            });
        });
    </script>
</body>
</html>